
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Room Database</title>
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../../elements/codelab.html">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <style is="custom-style">
    body {
      font-family: "Roboto",sans-serif;
      background: var(--google-codelab-background, #F8F9FA);
    }
  </style>
  
</head>
<body unresolved class="fullbleed">

  <google-codelab title="Room Database"
                  environment="web"
                  feedback-link="https://github.com/gerardfp">
    
      <google-codelab-step label="Introducció" duration="2">
        <p>Room proporciona una capa d&#39;abstracció sobre SQLite per a permetre l&#39;accés a bases de dades amb fluidesa mentre aprofita tot el poder de SQLite.</p>
<p>Les aplicacions que manegen quantitats no trivials de dades estructurades poden beneficiar-se enormement de la persistència d&#39;aquestes dades a nivell local. El cas d&#39;ús més comú és l&#39;emmagatzemament en <em>cache</em> de dades rellevants. D&#39;aquesta manera, quan el dispositiu no pot accedir a la xarxa, l&#39;usuario encara pot explorar aquest contingut mentre està desconnectat. Qualsevol canvi en el contingut iniciat por l&#39;usuario es sincronitza amb el servidor una cop que el dispositiu torna a estar connectat.</p>
<p>Hi ha 3 components principals en Room:</p>
<ul>
<li><a href="https://developer.android.com/reference/android/arch/persistence/room/Database.html" target="_blank"><strong>Base de dades:</strong></a> conté l&#39;agafador de la base de dades i serveix com a punt d&#39;accés principal per a la connexió subjacent a les dades relacionals persistents de l&#39;aplicació.</li>
<li><a href="https://developer.android.com/training/data-storage/room/defining-data.html" target="_blank"><strong>Entitat:</strong></a> representa una taula dintre de la base de dades.</li>
<li><a href="https://developer.android.com/training/data-storage/room/accessing-data.html" target="_blank"><strong>DAO:</strong></a> conté els mètodes utilitzats per a accedir a la base de dades</li>
</ul>
<p>.<img style="max-width: 269.00px" src="img\dcbc418590d3b477.png"></p>
<aside class="special"><p>Get the full code: <a href="https://github.com/gerardfp/room" target="_blank">https://github.com/gerardfp/room</a> </p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Crea el projecte" duration="2">
        <p>Afegeix els components per a <a href="https://developer.android.com/topic/libraries/architecture/adding-components#room" target="_blank">Room</a> i <a href="https://developer.android.com/topic/libraries/architecture/adding-components#lifecycle" target="_blank">Lifecycle</a></p>
<p>A l&#39;arxiu <code>build.gradle (Module: app)</code></p>
<pre><code>implementation &#34;android.arch.persistence.room:runtime:1.1.1&#34;
annotationProcessor &#34;android.arch.persistence.room:compiler:1.1.1&#34;

implementation &#34;android.arch.lifecycle:extensions:1.1.1&#34;
annotationProcessor &#34;android.arch.lifecycle:compiler:1.1.1&#34;</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Crea les entitats" duration="0">
        <pre><code>@Entity
public class Poem {
   @PrimaryKey (autoGenerate = true)
   public String id;

   public String author;
   public String title;
   public String content;
   public float rating;
}</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Crea el DAO" duration="0">
        <pre><code>@Dao
public interface PoemDAO {

   @Insert
   void insert(Poem poem);

   @Query(&#34;SELECT * FROM poem&#34;)
   LiveData&lt;List&lt;Poem&gt;&gt; getAllPoems();

   @Query(&#34;SELECT * FROM poem WHERE id = :id&#34;)
   LiveData&lt;Poem&gt; getPoem(int id);

   @Query(&#34;UPDATE poem SET rating=:rating WHERE id=:id&#34;)
   void setRating(int id, float rating);
}</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Crea la Base de Dades" duration="0">
        <pre><code>@Database(entities = {Poem.class}, version = 1)
public abstract class PoemRoomDatabase extends RoomDatabase {

   public abstract PoemDAO poemDAO();

   private static volatile PoemRoomDatabase INSTANCE;

   static PoemRoomDatabase getDatabase(final Context context) {
       if (INSTANCE == null) {
           synchronized (PoemRoomDatabase.class) {
               if (INSTANCE == null) {
                   INSTANCE = Room.databaseBuilder(context.getApplicationContext(),
                           PoemRoomDatabase.class, &#34;poem_database&#34;)
                           .build();
               }
           }
       }
       return INSTANCE;
   }
}</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Crea el Repository" duration="0">
        <pre><code>public class PoemRepository {

   private PoemDAO mPoemDao;

   PoemRepository(Application application) {
       mPoemDao = PoemRoomDatabase.getDatabase(application).poemDAO();
   }

   LiveData&lt;List&lt;Poem&gt;&gt; getAllPoems() {
       return mPoemDao.getAllPoems();
   }

   LiveData&lt;Poem&gt; getPoem(int id){ return mPoemDao.getPoem(id); }

   public void insert(Poem poem) {
       new insertAsyncTask(mPoemDao).execute(poem);
   }

   private static class insertAsyncTask extends AsyncTask&lt;Poem, Void, Void&gt; {

       private PoemDAO mAsyncTaskDao;

       insertAsyncTask(PoemDAO dao) {
           mAsyncTaskDao = dao;
       }

       @Override
       protected Void doInBackground(final Poem... params) {
           mAsyncTaskDao.insert(params[0]);
           return null;
       }
   }

   public void setRating(Poem poem){
       new setRatingAsyncTask(mPoemDao).execute(poem);
   }

   private static class setRatingAsyncTask extends AsyncTask&lt;Poem, Void, Void&gt; {

       private PoemDAO mAsyncTaskDao;

       setRatingAsyncTask(PoemDAO dao) {
           mAsyncTaskDao = dao;
       }

       @Override
       protected Void doInBackground(final Poem... params) {
           mAsyncTaskDao.setRating(params[0].id, params[0].rating);
           return null;
       }
   }
}</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Crea el ViewModel" duration="0">
        <pre><code>public class PoemViewModel extends AndroidViewModel {

   private PoemRepository mRepository;

   public PoemViewModel(Application application) {
       super(application);
       mRepository = new PoemRepository(application);
   }

   LiveData&lt;List&lt;Poem&gt;&gt; getAllPoems() { return mRepository.getAllPoems(); }

   LiveData&lt;Poem&gt; getPoem(int id){ return mRepository.getPoem(id); }

   public void insert(Poem poem) { mRepository.insert(poem); }

   public void setRating(Poem poem) { mRepository.setRating(poem); }
}</code></pre>


      </google-codelab-step>
    
  </google-codelab>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49880327-14', 'auto');

    (function() {
      var gaCodelab = '';
      if (gaCodelab) {
        ga('create', gaCodelab, 'auto', {name: 'codelab'});
      }

      var gaView;
      var parts = location.search.substring(1).split('&');
      for (var i = 0; i < parts.length; i++) {
        var param = parts[i].split('=');
        if (param[0] === 'viewga') {
          gaView = param[1];
          break;
        }
      }
      if (gaView && gaView !== gaCodelab) {
        ga('create', gaView, 'auto', {name: 'view'});
      }
    })();
  </script>

</body>
</html>
