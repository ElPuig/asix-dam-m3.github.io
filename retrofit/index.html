<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="module" src="/sofi/js/script.js"></script>
<link rel="stylesheet" href="/sofi/css/estil.css">

<nav></nav>
<header>
  <h1>Retrofit</h1>
  <abstract>
    <p><a href="https://square.github.io/retrofit/">Retrofit</a> es 
        una librería para realizar peticiones a una API HTTP.</p>

    <p>Desarrollaremos una app que buscará un término en la 
        <a href="https://affiliate.itunes.apple.com/resources/documentation/itunes-store-web-service-search-api/">API de iTunes</a> 
        y mostrará el contenido encontrado.</p>

    <img src="img/recyclerview.gif"/>

    <a href="https://github.com/gerardfp/recyclerview">https://github.com/gerardfp/recyclerview</a>
  </abstract>
</header>

<section>
    <h2>Crea el proyecto</h2>

    <ul>
        <li>
            <p>Añade las dependencias para las librerías Retrofit y Glide:</p>
            <scfile>
                build.gradle (Module: app)
            </scfile>
            <sc groovy data-line="4-5,7-8">

                dependencies {
                    // ...

                    implementation 'com.squareup.retrofit2:retrofit:2.9.0'
                    implementation 'com.squareup.retrofit2:converter-gson:2.9.0'
        
                    implementation 'com.github.bumptech.glide:glide:4.11.0'
                    annotationProcessor 'com.github.bumptech.glide:compiler:4.11.0'
                }
            </sc>        
        </li>

        <li>
            <p>Configura el ViewBinding</p>

            <scfile>
                build.gradle (Module: app)
            </scfile>
            <sc groovy data-line="4-6">
                android {
                    //...

                    buildFeatures {
                        viewBinding true
                    }
                }
            </sc>
        </li>
    
        <li>
            <p>Concede permiso de acceso a internet a la App:</p>
            <scfile>
                AndroidManifest.xml
            </scfile>
            <sc xml data-line="3">
                &lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; ...&gt;

                    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;

                    // ...
                &lt;/manifest&gt;
                </sc>
            </sc>

        </li>
        <li>
            <p>Crea el grafo de navegación <file>nav_graph.xml</file></p>
        </li>
        <li>
            <p>Añade el NavHostFragment en el layout de la MainActivity</p>

            <scfile>
                activity_main.xml
            </scfile>
            <sc xml>
                &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
                &lt;androidx.constraintlayout.widget.ConstraintLayout
                    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
                    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
                    android:layout_width=&quot;match_parent&quot;
                    android:layout_height=&quot;match_parent&quot;&gt;

                    &lt;androidx.fragment.app.FragmentContainerView
                        android:id=&quot;@+id/fragment&quot;
                        android:name=&quot;androidx.navigation.fragment.NavHostFragment&quot;
                        android:layout_width=&quot;match_parent&quot;
                        android:layout_height=&quot;match_parent&quot;
                        app:defaultNavHost=&quot;true&quot;
                        app:navGraph=&quot;@navigation/nav_graph&quot; /&gt;

                &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;
            </sc>
        </li>
        <li>
            <p>Crea un nuevo destino en el grafo de navegación llamado <w>ItunesFragment</w></p>
            <p>Configura el ViewBinding:</p>
            <scfile>
                ItunesFragment.java
            </scfile>
            <sc java>
                public class ItunesFragment extends Fragment {
                    private FragmentItunesBinding binding;
                
                    @Override
                    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container,
                                             Bundle savedInstanceState) {
                        return (binding = FragmentItunesBinding.inflate(inflater, container, false)).getRoot();
                    }
                
                    @Override
                    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
                        super.onViewCreated(view, savedInstanceState);
                        
                    }
                }
            </sc>
        </li>
    </ul>

</section>

<section>
    <h2>Itunes Api</h2>
    <p>Utilizaremos la librería <strong>retrofit</strong> para realizar llamadas a la api de Itunes y obtener los datos.
    La librería GSON, realizará el mapeo entre datos JSON y objetos Java.</p>

    <p>Para utilizar retrofit hay que se necesitan 3 cosas:</p>
    <ul>
        <li>Las clases para mapear el JSON</li>
        <li>Un interfaz que defina las llamadas HTTP</li>
        <li>Una variable en la que retrofit implementará el interfaz</li>
    </ul>

    <p>Crearemos estos 3 componentes en el mismo fichero (aunque se podría hacer en ficheros distintos). Crearemos la clase <w>Itunes.java</w>
    y pondremos estos 3 componentes como elementos <w>static</w> de esta clase:</p>

    <p>Crea el fichero <w>Itunes.java</w>:</p>

    <scfile>
        Itunes.java
    </scfile>
    <sc java>
        public class Itunes {

        }
    </sc>

    <h3>Clases para el mapeo</h3>

    <p>La respuesta de la llamada a la API <a href="http://itunes.apple.com/search?term=beatles">http://itunes.apple.com/search?term=beatles</a> es similar a la siguiente:</p>
    <sc json>
        {
            "results": [
                {
                    "artistName": "The Beatles",
                    "trackName": "Let It Be",
                    "artworkUrl100": "https://mzstatic.com/image/39b2caf.jpg"
                },
                {
                    "artistName": "The Beatles",
                    "trackName": "Here Comes the Sun",
                    "artworkUrl100": "https://mzstatic.com/image/6edbf5a8.jpg"
                }
            ]
        }
    </sc>

    <warn>
        <p>Solamente se deben tener en cuenta los datos que sean de interés para la app</p>
    </warn>

    <p>Se necesitarán estas dos clases para mapear la respuesta en objetos Java:</p>

    <scfile>
        Itunes.java
    </scfile>
    <sc java data-line="2-10">
        class Itunes {
            class Respuesta {
                List&lt;Contenido&gt; results;
            }

            class Contenido {
                String artistName;
                String trackName;
                String artworkUrl100;
            }
        }
    </sc>

    <h3>Api interface</h3>

    <p>El siguiente paso es crear un interfaz que defina las llamadas a la API REST.</p>

    <p>Definimos un método mediante el cual haremos la llamada, y especificamos la ruta de la URL a la que se debe hacer 
        la petición:
    </p>
    <scfile>
        Itunes.java
    </scfile>
    <sc java data-line="4-13">
        class Itunes {
            //...

            public static Api api = new Retrofit.Builder()
                    .baseUrl("https://itunes.apple.com/")
                    .addConverterFactory(GsonConverterFactory.create())
                    .build()
                    .create(Api.class);
            
            public interface Api {
                @GET("search/?term=beatles")
                Call&lt;Respuesta&gt; buscarBeatles();
            }
        }
    </sc>

    <p>Retrofit implementará automáticamente los métodos del objeto <w>api</w> a partir de los métodos definidos en 
        el <w>interface Api</w>.</p>

    <p>Cuando se llame <w>buscarBeatles()</w> se hará la petición a <url>https://itunes.apple.com/<replace>search/?term=beatles</replace></url>.
    
    <p>La respuesta a la llamada <w>buscarBeatles()</w> será un objeto de clase <w>Respuesta</w> rellenado con los datos obtenidos del JSON que haya 
    devuelto la petición.</p>
</section>

<section>
    <h2>ViewModel</h2>

    <p>En el ViewModel añadiremos un método <w>buscarBeatles()</w> que a su vez haga la llamada a <w>buscarBeatles()</w> de la API. La respuesta de la llamada la 
    guardaremos en un <w>MutableLiveData</w> que será observado por la Vista.</p>

    <p>La llamada a la API se debe hacer en segundo plano, para no bloquear el Thread Principal. Retrofit gestiona estas llamadas 
        en segundo plano llamando al método <w>enqueue()</w> y pasándole el <w>Callback</w> para que nos devuelva la respuesta 
        (o el error). Para obtener los datos "en sí" de la respuesta hay que acceder a través del método <w>body()</w>.
    </p>

    <p>El ViewModel quedará así:</p>
    <scfile>
        ItunesViewModel.java
    </scfile>
    <sc java>
        public class ItunesViewModel extends AndroidViewModel {

            MutableLiveData&lt;Itunes.Respuesta&gt; respuestaMutableLiveData = new MutableLiveData&lt;&gt;();
        
            public ItunesViewModel(@NonNull Application application) {
                super(application);
            }
        
            public void buscarBeatles(){
                Itunes.api.buscarBeatles().enqueue(new Callback&lt;Itunes.Respuesta&gt;() {
                    @Override
                    public void onResponse(@NonNull Call&lt;Itunes.Respuesta&gt; call, @NonNull Response&lt;Itunes.Respuesta&gt; response) {
                        respuestaMutableLiveData.postValue(response.body());
                    }
        
                    @Override
                    public void onFailure(@NonNull Call&lt;Itunes.Respuesta&gt; call, @NonNull Throwable t) {}
                });
            }
        }
    </sc>

    <info>
        <p>El callback <w>onFailure</w> se invocará cuando haya un error de red o cuando no se pueda procesar la respuesta. 
        En esta app no gestionaremos el error, pero estaría bien, al menos, que se notificara al usuario.</p>
    </info>
</section>

<section>
    <h2>ItunesFragment</h2>

    <p>El <w>ItunesFragment</w> debe dar la orden al ViewModel de que haga la petición a la API. También observará la variable 
        <w>respuestaMutableLiveData</w>, para mostrar los resultados en un <w>RecyclerView</w>.</p>

    <p>Primero veremos como obtener la Respuesta de la API, y la mostraremos en el <w>Log</w>, y después implementaremos 
    el RecyclerView.</p>

    <scfile>
        ItunesFragment.java
    </scfile>
    <sc java>
        @Override
        public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
            // ...

            ItunesViewModel itunesViewModel = new ViewModelProvider(this).get(ItunesViewModel.class);

            itunesViewModel.buscarBeatles();

            itunesViewModel.respuestaMutableLiveData.observe(getViewLifecycleOwner(), new Observer&lt;Itunes.Respuesta&gt;() {
                @Override
                public void onChanged(Itunes.Respuesta respuesta) {
                    respuesta.results.forEach(contenido -&gt; Log.e(&quot;ABCD&quot;, contenido.artistName + &quot;, &quot; + contenido.trackName + &quot;, &quot; + contenido.artworkUrl100));
                }
            });
        }
    </sc>

    <p>Si ejecutamos la app, en el Logcat podremos ver cada <w>Contenido</w> del array <w>results</w> de la respuesta:</p>
    <shell>
        E/ABCD: The Beatles, Here Comes the Sun, https://mzstatic.com/image/6edbf5a8.jpg
        E/ABCD: The Beatles, Let It Be, https://mzstatic.com/image/a81e35cd.jpg
        E/ABCD: The Beatles, Come Together, https://mzstatic.com/image/96ae4cf.jpg
        E/ABCD: The Beatles, Hey Jude, https://mzstatic.com/image/fe9cb34a.jpg
    </shell>

    <h3>RecyclerView</h3>

    <p>El siguiente paso es mostrar el array <w>result</w> (<w>List&lt;Contenido&gt; result;</w>) en un RecyclerView.</p>

    <ul>
        <li>
            <p>Añadiremos el <w>&lt;RecyclerView&gt;</w> al layout:</p>
            <scfile>
                fragment_itunes.xml
            </scfile>
            <sc xml>
                &lt;androidx.recyclerview.widget.RecyclerView
                    android:id=&quot;@+id/recyclerview_contenidos&quot;
                    android:layout_width=&quot;match_parent&quot;
                    android:layout_height=&quot;wrap_content&quot;
                    app:layoutManager=&quot;androidx.recyclerview.widget.GridLayoutManager&quot;
                    app:spanCount=&quot;2&quot;/&gt;
            </sc>

            <p>Hemos usado el GridLayoutManager para mostrar los elementos en rejilla. En el atributo <w>spanCount</w> hemos 
            especificado <w>2</w> columnas para la rejilla.</p>
        </li>
        <li>
            <p>Creamos el ViewHolder:</p>
            <ul>
                <li><p>Layout:</p>
                    <scfile>
                        res/layout/viewholder_contenido.xml
                    </scfile>
                    <sc xml>
                        &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
                        &lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
                            android:layout_width=&quot;match_parent&quot;
                            android:layout_height=&quot;wrap_content&quot;
                            android:orientation=&quot;vertical&quot;&gt;
                            &lt;TextView
                                android:id=&quot;@+id/artist&quot;
                                android:layout_width=&quot;match_parent&quot;
                                android:layout_height=&quot;wrap_content&quot; /&gt;
                            &lt;TextView
                                android:id=&quot;@+id/title&quot;
                                android:layout_width=&quot;match_parent&quot;
                                android:layout_height=&quot;wrap_content&quot; /&gt;
                            &lt;ImageView
                                android:id=&quot;@+id/artwork&quot;
                                android:layout_width=&quot;wrap_content&quot;
                                android:layout_height=&quot;wrap_content&quot;
                                android:adjustViewBounds=&quot;true&quot;/&gt;
                        &lt;/LinearLayout&gt;
                    </sc>
                </li>
                <li>
                    <p>Clase:</p>
                    <scfile>
                        ItunesFragment.java
                    </scfile>
                    <sc java data-line="4-11">
                        public class ItunesFragment extends Fragment {
                            // ...

                            static class ContenidoViewHolder extends RecyclerView.ViewHolder {
                                ViewholderContenidoBinding binding;
                        
                                public ContenidoViewHolder(@NonNull ViewholderContenidoBinding binding) {
                                    super(binding.getRoot());
                                    this.binding = binding;
                                }
                            }
                        }
                    </sc>
                </li>
            </ul>
        </li>
        <li><p>Creamos el Adaptador:</p>

            <scfile>
                ItunesFragment.java
            </scfile>
            <sc java data-line="4-31">
                public class ItunesFragment extends Fragment {
                    //...

                    class ContenidosAdapter extends RecyclerView.Adapter&lt;ContenidoViewHolder&gt;{
                        List&lt;Itunes.Contenido&gt; contenidoList;
                
                        @NonNull
                        @Override
                        public ContenidoViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
                            return new ContenidoViewHolder(ViewholderContenidoBinding.inflate(getLayoutInflater(), parent, false));
                        }
                
                        @Override
                        public void onBindViewHolder(@NonNull ContenidoViewHolder holder, int position) {
                            Itunes.Contenido contenido = contenidoList.get(position);
                
                            holder.binding.title.setText(contenido.trackName);
                            holder.binding.artist.setText(contenido.artistName);
                            Glide.with(requireActivity()).load(contenido.artworkUrl100).into(holder.binding.artwork);
                        }
                
                        @Override
                        public int getItemCount() {
                            return contenidoList == null ? 0 : contenidoList.size();
                        }
                
                        void establecerListaContenido(List&lt;Itunes.Contenido&gt; contenidoList){
                            this.contenidoList = contenidoList;
                            notifyDataSetChanged();
                        }
                    }
                }
            </sc>

        </li>
        <li>
            <p>Establecemos el Adaptador al RecyclerView:</p>
            <scfile>
                ItunesFragment.java
            </scfile>
            <sc java data-line="5,6">
                @Override
                public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
                    //...

                    ContenidosAdapter contenidosAdapter = new ContenidosAdapter();
                    binding.recyclerviewContenidos.setAdapter(contenidosAdapter);
                }
            </sc>
        </li>

        <li>
            <p>Actualizamos la lista del Adaptador cuando obtengamos la respuesta de la API:</p>
            <scfile>
                ItunesFragment.java
            </scfile>
            <sc java data-line="5-11">
                @Override
                public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
                    //...

                    itunesViewModel.respuestaMutableLiveData.observe(getViewLifecycleOwner(), new Observer&lt;Itunes.Respuesta&gt;() {
                        @Override
                        public void onChanged(Itunes.Respuesta respuesta) {
                            contenidosAdapter.establecerListaContenido(respuesta.results);
                            // respuesta.results.forEach(r -&gt; Log.e(&quot;ABCD&quot;, r.artistName + &quot;, &quot; + r.trackName + &quot;, &quot; + r.artworkUrl100));
                        }
                    });
                }
            </sc>
        </li>
    </ul>

    <p><strong>Si ejecutas la app, debería verse la lista de contenidos de los Beatles.</strong></p>

</section>

<section>
    <h2>Búsqueda</h2>

    // IN PROGRESS...
    <p></p>
    
el parámetro <w>texto</w> que se pase al metodo <w>buscar()</w> se añadirá a la query de la URL con el nombre <w>term</w>. 
Por ejemplo: si se llama al método <w>buscar("beatles")</w> se efectuará la siguiente petición: <url>https://itunes.apple.com/<replace>search/?term=beatles</replace></url> </p>

</section>
