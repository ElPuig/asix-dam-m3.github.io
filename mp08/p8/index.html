
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Retrofit</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="mp08/p8"
                  title="Retrofit"
                  environment="web"
                  feedback-link="https://github.com/gerardfp">
    
      <google-codelab-step label="Introducció" duration="0">
        <p>El objetivo de esta práctica es aprender a usar las librerías <a href="https://square.github.io/retrofit/" target="_blank">Retrofit</a> y <a href="https://github.com/bumptech/glide" target="_blank">Glide</a>.</p>
<p>La librería <code>Retrofit</code> permite acceder a API REST.</p>
<p>La librería <code>Glide</code> permite cargar imágenes.</p>
<p>Desarrollaremos una App que buscará un término en la <a href="https://affiliate.itunes.apple.com/resources/documentation/itunes-store-web-service-search-api/" target="_blank">API de iTunes</a> y mostrará el contenido encontrado.</p>
<p>Talk is cheap. Show me the code: <a href="https://github.com/gerardfp/retrofit" target="_blank">https://github.com/gerardfp/retrofit</a></p>
<p class="image-container"><img style="width: 242.00px" src="img\e07a46120ce1b440.gif"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Crea el proyecto" duration="0">
        <h2 is-upgraded>Dependencias</h2>
<p>Añade las librerías <code>Retrofit</code> y <code>Glide</code> en las dependencias <code>build.gradle (Module: app)</code>:</p>
<pre><code>implementation &#39;com.squareup.retrofit2:retrofit:2.6.2&#39;
implementation &#39;com.squareup.retrofit2:converter-gson:2.6.2&#39;


implementation &#39;com.github.bumptech.glide:glide:4.10.0&#39;
annotationProcessor &#39;com.github.bumptech.glide:compiler:4.10.0&#39;</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="API Model" duration="0">
        <p>La respuesta de la llamada a la API <a href="http://api.themoviedb.org/3/discover/movie?api_key=YOUR_API_KEY" target="_blank"><code>http://itunes.apple.com/search?term=beatles</code></a> es similar a la siguiente:</p>
<p>*Únicamente tenemos que tener en cuenta los datos <strong>de interés</strong> para nuestra app</p>
<pre><code>{
    &#34;results&#34;: [
        {
            &#34;artistName&#34;: &#34;The Beatles&#34;,
            &#34;trackName&#34;: &#34;Let It Be&#34;,
            &#34;artworkUrl100&#34;: &#34;https://mzstatic.com/image/39b2caf.jpg&#34;,
        },
        {
            &#34;artistName&#34;: &#34;The Beatles&#34;,
            &#34;trackName&#34;: &#34;Here Comes the Sun&#34;,
            &#34;artworkUrl100&#34;: &#34;https://mzstatic.com/image/6edbf5a8.jpg&#34;,
        },
    ]
}</code></pre>
<p>La respuesta es un objeto que contiene las siguientes variables:</p>
<ul>
<li><code>results</code> de tipo <code>ArrayList</code></li>
</ul>
<p>Cada elemento del ArrayList <code>results</code> es un objeto que contiene la siguientes variables:</p>
<ul>
<li><code>artistName</code> de tipo <code>String</code></li>
<li><code>trackName</code> de tipo <code>String</code></li>
<li><code>artworkUrl100</code> de tipo <code>String</code></li>
</ul>
<p>Así pues podemos modelar estos objetos con las siguientes clases:</p>
<pre><code>public class ItunesResponse {
   public List&lt;Content&gt; results;
}</code></pre>
<pre><code>public class Content {
   public String artistName;
   public String trackName;
   public String artworkUrl100;
}</code></pre>
<aside class="special"><p>Para organizar el código, crea estas dos clases dentro de un package llamado <code>model</code>.</p>
<p class="image-container"><img style="width: 167.00px" src="img\35bbe171d270a8f2.png"></p>
</aside>
<p>A la hora de modelar un JSON, la regla a seguir es:</p>
<p>Por cada  <code>{</code>  se ha de crear una clase, y por cada  <code>[</code>  un ArrayList:</p>
<p class="image-container"><img style="width: 736.40px" src="img\9d00021dea43e552.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="API Calls" duration="0">
        <p>Definimos las llamadas a la API en un Interface</p>
<pre><code>import retrofit2.Call;
import retrofit2.http.GET;
import retrofit2.http.Query;

public interface ItunesApi {
   @GET(&#34;search/&#34;)
   Call&lt;ItunesResponse&gt; buscar(@Query(&#34;term&#34;) String term);
}</code></pre>
<aside class="special"><p>Para organizar el código, crea esta clase dentro de un package llamado <code>api</code>.</p>
</aside>
<p>Retrofit transformará cada llamada al método <code>buscar()</code> en una llamada a la API.</p>
<p>Con la anotación <code>@GET</code> indicamos la URL a la que se debe acceder. En este caso, la anotación <code>@GET(&#34;search/&#34;)</code> se transforma en la URL <a href="https://itunes.apple.com/search/" target="_blank"><code>https://itunes.apple.com/</code><strong><code>search/</code></strong></a></p>
<p>La anotación <code>@Query</code> sirve para añadir parámetros a la URL. En este caso la anotación <code>@Query(&#34;term&#34;)</code> añadirá a la URL el parámetro <code>?term=</code>. El valor de este parámetro será el que le pasemos a la llamada a <code>buscar()</code>.</p>
<p>Por ejemplo, si efectuamos la llamada <code>buscar(&#34;beatles&#34;)</code> se añadirá a la URL el parámetro <code>?term=beatles</code>, con lo cual la llamada quedará así <a href="https://itunes.apple.com/search/?term=beatles" target="_blank"><code>https://itunes.apple.com/search/</code><strong><code>?term=beatles</code></strong></a></p>


      </google-codelab-step>
    
      <google-codelab-step label="Api Module" duration="0">
        <p>La siguiente clase ItunesApiModule es la que genera la implementación del interfaz ItunesApi que hemos definido anteriormente.</p>
<ul>
<li>Se especifica la URL Base <a href="https://itunes.apple.com/" target="_blank"><strong><code>https://itunes.apple.com/</code></strong></a></li>
<li>Se añade el conversor Gson, que será el encargado de parsear el JSON que devulve iTunes y convertirlo en objetos de las clases que hemos definido (<code>ItunesResponse</code> y <code>Content</code>)</li>
</ul>
<pre><code>import retrofit2.Retrofit;
import retrofit2.converter.gson.GsonConverterFactory;

public class ItunesApiModule {
   public static ItunesApi itunesApi = new Retrofit.Builder()
           .baseUrl(&#34;https://itunes.apple.com/&#34;)
           .addConverterFactory(GsonConverterFactory.create())
           .build()
           .create(ItunesApi.class);
}</code></pre>
<aside class="special"><p>Crea esta clase dentro del package <code>api</code>.</p>
</aside>
<p>El objeto <code>itunesApi</code> contiene la implementación de todos los métodos que hayamos definido en la clase <code>ItunesApi</code>.</p>
<h2 is-upgraded>Opcional</h2>
<p>Con el fin de <em>debuggear</em> la app, y ver en el Logcat las llamadas que se realicen a la API, podemos añadir un <code>Interceptor</code>. Su función será interceptar cada llamada que se realice y <em>loggearla</em> en el Logcat:</p>
<pre><code>import android.util.Log;
import java.io.IOException;
import okhttp3.Interceptor;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import retrofit2.Retrofit;
import retrofit2.converter.gson.GsonConverterFactory;

public class ItunesApiModule {
   public static ItunesApi itunesApi = new Retrofit.Builder()
           .baseUrl(&#34;https://itunes.apple.com/&#34;)
           .client(new OkHttpClient.Builder()
                   .addInterceptor(new Interceptor() {
                       @Override
                       public Response intercept(Chain chain) throws IOException {
                           Request request = chain.request();

                           long t1 = System.nanoTime();
                           Log.e(&#34;INTERCEPTOR&#34;, String.format(&#34;Sending request %s on %s%n%s&#34;,
                                   request.url(), chain.connection(), request.headers()));

                           okhttp3.Response response = chain.proceed(request);

                           long t2 = System.nanoTime();
                           Log.e(&#34;INTERCEPTOR---&#34;, String.format(&#34;Received response for %s in %.1fms%n%s&#34;,
                                   response.request().url(), (t2 - t1) / 1e6d, response.headers()));

                           return response;
                       }
                   })
                   .build()
           )
           .addConverterFactory(GsonConverterFactory.create())
           .build()
           .create(ItunesApi.class);
}</code></pre>
<p>Con este Interceptor, cada vez que nuestra app realice una llamada a la API, se mostrará en el Logcat:</p>
<p class="image-container"><img style="width: 736.40px" src="img\3a2581fe590b5140.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="ViewModel" duration="0">
        <p class="image-container"><img style="width: 661.00px" src="img\3cc96e17b368b6bb.png"></p>
<pre><code>import android.app.Application;

import androidx.annotation.NonNull;
import androidx.arch.core.util.Function;
import androidx.lifecycle.AndroidViewModel;
import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.Transformations;
import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;

public class MainViewModel extends AndroidViewModel {

   MutableLiveData&lt;String&gt; searchTerm = new MutableLiveData&lt;&gt;();

   public LiveData&lt;ItunesResponse&gt; itunesResponse = Transformations.switchMap(searchTerm, new Function&lt;String, LiveData&lt;ItunesResponse&gt;&gt;() {
       @Override
       public LiveData&lt;ItunesResponse&gt; apply(String term) {
           final MutableLiveData&lt;ItunesResponse&gt; itunesResponseMutableLiveData = new MutableLiveData&lt;&gt;();

           ItunesApiModule.itunesApi.buscar(term).enqueue(new Callback&lt;ItunesResponse&gt;() {
               @Override
               public void onResponse(Call&lt;ItunesResponse&gt; call, Response&lt;ItunesResponse&gt; response) {
                   itunesResponseMutableLiveData.postValue(response.body());
               }

               @Override
               public void onFailure(Call&lt;ItunesResponse&gt; call, Throwable t) {}
           });

           return itunesResponseMutableLiveData;
       }
   });

   public MainViewModel(@NonNull Application application) {
       super(application);
   }

   public void setTerm(String term){
       searchTerm.setValue(term);
   }
}</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="MainActivity" duration="0">
        <p><code>main_activity.xml</code></p>
<pre><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
&lt;LinearLayout xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
   xmlns:app=&#34;http://schemas.android.com/apk/res-auto&#34;
   android:layout_width=&#34;match_parent&#34;
   android:layout_height=&#34;match_parent&#34;
   android:layout_marginLeft=&#34;16dp&#34;
   android:layout_marginRight=&#34;16dp&#34;
   android:orientation=&#34;vertical&#34;&gt;

   &lt;SearchView
       android:id=&#34;@+id/search_term&#34;
       android:layout_width=&#34;match_parent&#34;
       android:layout_height=&#34;wrap_content&#34; /&gt;

   &lt;androidx.recyclerview.widget.RecyclerView
       android:id=&#34;@+id/songs_list&#34;
       android:layout_width=&#34;match_parent&#34;
       android:layout_height=&#34;wrap_content&#34;
       app:layoutManager=&#34;androidx.recyclerview.widget.GridLayoutManager&#34;
       app:spanCount=&#34;2&#34;/&gt;

&lt;/LinearLayout&gt;</code></pre>
<p><code>viewholder_content.xml</code></p>
<pre><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
&lt;LinearLayout xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
   android:orientation=&#34;vertical&#34;
   android:layout_width=&#34;match_parent&#34;
   android:layout_height=&#34;wrap_content&#34;
   android:layout_marginBottom=&#34;16dp&#34;&gt;

   &lt;TextView
       android:id=&#34;@+id/song_artist&#34;
       android:layout_width=&#34;match_parent&#34;
       android:layout_height=&#34;wrap_content&#34;
       android:textSize=&#34;16sp&#34;/&gt;
   &lt;TextView
       android:id=&#34;@+id/song_title&#34;
       android:layout_width=&#34;match_parent&#34;
       android:layout_height=&#34;wrap_content&#34;
       android:textSize=&#34;20sp&#34;
       android:textStyle=&#34;bold&#34;/&gt;
   &lt;ImageView
       android:id=&#34;@+id/song_image&#34;
       android:layout_width=&#34;wrap_content&#34;
       android:layout_height=&#34;wrap_content&#34;
       android:adjustViewBounds=&#34;true&#34;/&gt;

&lt;/LinearLayout&gt;</code></pre>
<p><code>MainActivity.java</code></p>
<pre><code>import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.SearchView;
import android.widget.TextView;

import com.bumptech.glide.Glide;

import java.util.ArrayList;
import java.util.List;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.lifecycle.Observer;
import androidx.lifecycle.ViewModelProviders;
import androidx.recyclerview.widget.RecyclerView;

public class MainActivity extends AppCompatActivity {

   List&lt;Content&gt; contentList = new ArrayList&lt;&gt;();
   ContentAdapter contentAdapter;
   MainViewModel mainViewModel;

   @Override
   protected void onCreate(Bundle savedInstanceState) {
       super.onCreate(savedInstanceState);
       setContentView(R.layout.activity_main);

       RecyclerView recyclerView = findViewById(R.id.songs_list);
       recyclerView.setAdapter(contentAdapter = new ContentAdapter());

       mainViewModel = ViewModelProviders.of(this).get(MainViewModel.class);

       SearchView searchView = findViewById(R.id.search_term);
       searchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
           @Override
           public boolean onQueryTextSubmit(String s) { return false; }

           @Override
           public boolean onQueryTextChange(String s) {
               mainViewModel.setTerm(s);
               return false;
           }
       });

       mainViewModel.itunesResponse.observe(MainActivity.this, new Observer&lt;ItunesResponse&gt;() {
           @Override
           public void onChanged(ItunesResponse itunesResponse) {
               contentList = itunesResponse.results; // if != null
               contentAdapter.notifyDataSetChanged();
           }
       });
   }

   class ContentViewHolder extends RecyclerView.ViewHolder {
       TextView title, artist;
       ImageView image;

       public ContentViewHolder(@NonNull View itemView) {
           super(itemView);
           title = itemView.findViewById(R.id.song_title);
           artist = itemView.findViewById(R.id.song_artist);
           image = itemView.findViewById(R.id.song_image);
       }
   }

   class ContentAdapter extends RecyclerView.Adapter&lt;ContentViewHolder&gt;{

       @NonNull
       @Override
       public ContentViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
           return new ContentViewHolder(LayoutInflater.from(parent.getContext()).inflate(R.layout.viewholder_content, parent, false));
       }

       @Override
       public void onBindViewHolder(@NonNull ContentViewHolder holder, int position) {
           Content content = contentList.get(position);

           holder.title.setText(content.trackName);
           holder.artist.setText(content.artistName);
           Glide.with(MainActivity.this).load(content.artworkUrl100).into(holder.image);
       }

       @Override
       public int getItemCount() {
           return contentList.size();
       }
   }
}</code></pre>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
